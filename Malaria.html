<script>
    jQuery(document).ready( function() {

        function exportTableToCSV($table, filename) {

            var $rows = $table.find('tr:has(td)'),

                // Temporary delimiter characters unlikely to be typed by keyboard
                // This is to avoid accidentally splitting the actual contents
                tmpColDelim = String.fromCharCode(11), // vertical tab character
                tmpRowDelim = String.fromCharCode(0), // null character

                // actual delimiter characters for CSV format
                colDelim = '","',
                rowDelim = '"\r\n"',

                // Grab text from table into CSV formatted string
                csv = '"' + $rows.map(function (i, row) {
                        var $row = $(row),
                            $cols = $row.find('td');

                        return $cols.map(function (j, col) {
                            var $col = $(col),
                                text = $col.text();

                            return text.replace(/"/g, '""'); // escape double quotes

                        }).get().join(tmpColDelim);

                    }).get().join(tmpRowDelim)
                        .split(tmpRowDelim).join(rowDelim)
                        .split(tmpColDelim).join(colDelim) + '"';

            // Deliberate 'false', see comment below
            if (false && window.navigator.msSaveBlob) {

                var blob = new Blob([decodeURIComponent(csv)], {
                    type: 'text/csv;charset=utf8'
                });

                // Crashes in IE 10, IE 11 and Microsoft Edge
                // See MS Edge Issue #10396033: https://goo.gl/AEiSjJ
                // Hence, the deliberate 'false'
                // This is here just for completeness
                // Remove the 'false' at your own risk
                window.navigator.msSaveBlob(blob, filename);

            } else if (window.Blob && window.URL) {
                // HTML5 Blob
                var blob = new Blob([csv], { type: 'text/csv;charset=utf8' });
                var csvUrl = URL.createObjectURL(blob);

                $(this)
                    .attr({
                        'download': filename,
                        'href': csvUrl
                    });
            } else {
                // Data URI
                var csvData = 'data:application/csv;charset=utf-8,' + encodeURIComponent(csv);

                $(this)
                    .attr({
                        'download': filename,
                        'href': csvData,
                        'target': '_blank'
                    });
            }
        }

        // This must be a hyperlink
        $(".export").on('click', function (event) {
            // CSV
            var args = [$('#tab-1>table'), 'performance.csv'];

            exportTableToCSV.apply(this, args);

            // If CSV, don't do event.preventDefault() or return false
            // We actually need this to be a typical hyperlink
        });

    });
</script>
<script type="text/javascript" src="../dhis-web-commons/oust/oust.js?_rev=20029"></script>
<script type="text/javascript" src="javascript/dataCompleteness.js?_rev=20029"></script>
<script type="text/javascript" src="../api/files/script?_rev=20029"></script>
<script>
    var currentPeriodOffset = 0;
    var periodTypeFactory = new PeriodType();


    function displayPeriods(){
        var periodType = $( "#periodType" ).val();
        var periods = periodTypeFactory.get( periodType ).generatePeriods(currentPeriodOffset );
        periods = periodTypeFactory.reverse( periods );
        periods = periodTypeFactory.filterFuturePeriodsExceptCurrent( periods );
        $( "#periodId" ).removeAttr( "disabled" );
        clearListById( "periodId" );

        for ( i in periods )
        {
            addOptionById( "periodId", periods[i].iso, periods[i].name );
        }
    }

    function displayNextPeriods(){
        if ( currentPeriodOffset < 0 ) // Cannot display future periods
        {
            currentPeriodOffset++;
            displayPeriods();
        }
    }

    function displayPreviousPeriods(){
        currentPeriodOffset--;
        displayPeriods();
    }
    var dateFormat = 'yy-mm-dd';
    dhis2.period.format = 'yyyy-mm-dd';
    dhis2.period.calendar = $.calendars.instance('gregorian');
    dhis2.period.generator = new dhis2.period.PeriodGenerator( dhis2.period.calendar, dhis2.period.format );
    dhis2.period.picker = new dhis2.period.DatePicker( dhis2.period.calendar, dhis2.period.format );
</script>

<style type="text/css">.container-content{
    overflow-x: auto;
}
</style>
<p><span style="font-size:12px;">
<style type="text/css">table.tableizer-table {
    font-size: 12px;
    border: 1px solid #CCC;
    font-family: Arial, Helvetica, sans-serif;
}
.tableizer-table td {
    padding: 4px;
    margin: 3px;
    border: 1px solid #CCC;
}
.tableizer-table th {
    background-color: #104E8B;
    color: #FFF;
    font-weight: bold;
}
.tableizer-table span {
    width: 1em;
    word-wrap: break-word;
}
</style>
<script type="text/javascript">
    function getreport() {
        var orgUnit = dhis2.report.organisationUnit;
        var period = $( "#periodId" ).val();
        $("#ou").html(orgUnit.name);
        $("#reportPeriod").html(period);
        console.log(dhis2.report);

//        performance

        $.get("../api/analytics.json?dimension=pe:"+period+"&dimension=dx:P4hvymX081j.HllvX50cXC0;xCL2pH3iemC.HllvX50cXC0;" +
                "otbw2kIEUGO.HllvX50cXC0;pUih6k0Rw2Z.HllvX50cXC0;d3GBSOMOMCJ.s3wXi7AxrqM;" +
                "d3GBSOMOMCJ.nozAOHqLOkI;d3GBSOMOMCJ.ZM7SBqwEmUZ;q9MU74zVFbS.HllvX50cXC0;nO2Qt1aQgGt.HllvX50cXC0;" +
                "ph1qBBRzCaS.zHSeMiszM8b;ph1qBBRzCaS.Evq43lpHFBO"+
            "&filter=ou:"+orgUnit.id+"&displayProperty=NAME&hierarchyMeta=true&showHierarchy=true&&tableLayout=true",
            function( json1 ) {
                if((json1.rows).length > 0){
                    for(var i = 0; i < (json1.rows).length; i++){
                        if(json1.rows[i][2]!=""){
                            $("span#"+json1.rows[i][0]).parent().css("text-align", "center");
                            $("span#"+json1.rows[i][0]).css("font-weight", "bold");

                            var id = json1.rows[i][0];

                            if ((json1.rows[i][0]).includes(".")){
                                var str = id.split(".");
                                $( "#"+str[0]+ "-"+str[1] ).html(Math.round(json1.rows[i][2]));
                            }else {
                                $( "#"+id).html(Math.round(json1.rows[i][2]));
                            }



                        } else {
                            $( "#"+json1.rows[i][0] ).html("0");
                        }
                    }
                }else {
                    alert("No performance data available for selected period");
                }

            } );

        $.get("../api/analytics.json?dimension=pe:"+period+"&dimension=dx:ShC4nyq3dYj.HllvX50cXC0;dmw9l7vXwGp.HllvX50cXC0;" +
                "tYKSgbaczpT.HllvX50cXC0;mJUczLXzUbg.HllvX50cXC0;BFG2SwWoDGk.s3wXi7AxrqM;BFG2SwWoDGk.nozAOHqLOkI;" +
                "BFG2SwWoDGk.ZM7SBqwEmUZ;swR5MjbGClU.HllvX50cXC0;AhpAuZWJcm6.HllvX50cXC0;O06aIjjaGLd.zHSeMiszM8b;O06aIjjaGLd.Evq43lpHFBO" +
            "&filter=ou:"+orgUnit.id+"&displayProperty=NAME&hierarchyMeta=true&showHierarchy=true&&tableLayout=true",
            function( json2 ) {
                if((json2.rows).length > 0){
                    for(var i = 0; i < (json2.rows).length; i++){
                        if(json2.rows[i][2]!=""){
                            $("span#"+json2.rows[i][0]).parent().css("text-align", "center");
                            $("span#"+json2.rows[i][0]).css("font-weight", "bold");

                            var id = json2.rows[i][0];
                            var str = id.split(".");
                            $( "#"+str[0]+ "-"+str[1] ).html(Math.round(json2.rows[i][2]));

                        } else {
                            $( "#"+json2.rows[i][0] ).html("0");
                        }
                    }
                }else {
                    alert("No target data available for selected period");
                }

            } );

        $.get("../api/analytics.json?dimension=pe:"+period+"&dimension=dx:EzeTnxCVAp3;sKmSA6MHgJL;" +
                "MazTDPituok;TB20t4ai1nH;av1k6Ws36cT;Sgaba8MkVHa;vyNFRVd9LHj;DI873BXKeZv;o3zpWesIKOD;Qw8gK8mtefi;x8ZtBl1U3Pv;" +
                "PXRZfgovVxj&filter=ou:"+orgUnit.id+"&displayProperty=NAME&hierarchyMeta=true&showHierarchy=true&&tableLayout=true",
            function( json ) {
                if((json.rows).length > 0){
                    for(var i = 0; i < (json.rows).length; i++){
                        if(json.rows[i][2]!=""){
                            $("span#"+json.rows[i][0]).css("color", "white");
                            $("span#"+json.rows[i][0]).parent().css("text-align", "center");
                            $("span#"+json.rows[i][0]).css("font-weight", "bold");
                            $( "#"+json.rows[i][0] ).html( json.rows[i][2] );
                            if(json.rows[i][2] < 25.0){
                                $("span#"+json.rows[i][0]).parent().css("background-color", "red");
                            }else if(json.rows[i][2] < 50.0){
                                $("span#"+json.rows[i][0]).parent().css("background-color", "orange");
                                $("span#"+json.rows[i][0]).css("color", "black");
                            }else if(json.rows[i][2] < 75.0){
                                $("span#"+json.rows[i][0]).parent().css("background-color", "yellow");
                                $("span#"+json.rows[i][0]).css("color", "black");
                            }
                            else if(json.rows[i][2] < 200.0){
                                $("span#"+json.rows[i][0]).parent().css("background-color", "green");
                            }else {
                                $("span#"+json.rows[i][0]).parent().css("background-color", "blue");
                            }

                        } else {
                            $( "#"+json.rows[i][0] ).html("0");
                            $("span#"+json.rows[i][0]).parent().css("background-color", "red");
                        }
                    }
                }else {
                    alert("No data available for selected period");
                }

            } );

    };

</script> </span></p>

<h3><span style="font-size:14px;">Malaria Performance</span></h3>

<h3><span id="ou" style="font-size:14px;"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span id="reportPeriod" style="font-size:14px;">&nbsp;</span> Report</h3>

<div class="inputSection" style="padding-bottom: 10px;">
    <label>Report period</label><br>
    <select id="periodType" name="periodType" style="width:174px" onchange="displayPeriods()">
        <option value="">[ Select period type ]</option>
        <!--<option value="Daily">Daily</option>-->
        <!--<option value="Weekly">Weekly</option>-->
        <!--<option value="Monthly">Monthly</option>-->
        <!--<option value="BiMonthly">Bimonthly</option>-->
        <!--<option value="Quarterly">Quarterly</option>-->
        <!--<option value="SixMonthly">Six-monthly</option>-->
        <!--<option value="SixMonthlyApril">Six-monthly April</option>-->
        <!--<option value="Yearly">Yearly</option>-->
        <!--<option value="FinancialApril">Financial-April</option>-->
        <!--<option value="FinancialJuly">Financial-July</option>-->
        <option value="FinancialOct">Financial-Oct</option>
    </select>
    <input type="button" style="width:75px" value="Prev year" onclick="displayPreviousPeriods()" />
    <input type="button" style="width:75px" value="Next year" onclick="displayNextPeriods()" /><br>

    <select id="periodId" name="periodId" style="width:330px" disabled="disabled">
    </select>
</div>
<p></p>
<p></p>
<button VALUE="submit" ONCLICK="getreport()">Submit</button>
<p></p>
<p></p>

<div>
    <div class="left" id="tabs">
        <div class="container-content" id="tab-1" style="width:80%">
            <table class="tableizer-table">
                <thead>
                <tr class="tableizer-firstrow">
                    <td style="background-color: rgb(16, 78, 139); text-align: center;"><span style="font-size:12px;"><strong><span style="font-size:16px;"><span style="color: rgb(255, 255, 224);">Indicator</span></span></strong></span></td>
                    <td style="background-color: rgb(16, 78, 139); text-align: center;"><span style="font-size:12px;"><strong><span style="font-size:16px;"><span style="color: rgb(255, 255, 224);">Performance</span></span></strong></span></td>
                    <td style="background-color: rgb(16, 78, 139); text-align: center;"><span style="font-size:12px;"><strong><span style="font-size:16px;"><span style="color: rgb(255, 255, 224);">Target</span></span></strong></span></td>
                    <td style="background-color: rgb(16, 78, 139); text-align: center;"><span style="font-size:12px;"><strong><span style="font-size:16px;"><span style="color: rgb(255, 255, 224);">% Achievement</span></span></strong></span></td>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td><span style="font-size:12px;">Number of artemisinin-based combination therapy (ACT) treatments purchased with USG funds</span></td>
                    <td><span id="xCL2pH3iemC-HllvX50cXC0" style="font-size:12px;">&nbsp;</span></td>
                    <td><span id="dmw9l7vXwGp-HllvX50cXC0" style="font-size:12px;">&nbsp;</span></td>
                    <td><span id="sKmSA6MHgJL" style="font-size:12px;"></span></td>
                </tr>
                <tr>
                    <td><span style="font-size:12px;">Number of artemisinin-based combination therapy (ACT) treatments purchased in any fiscal year with USG funds that were distributed in this reported fiscal year</span></td>
                    <td><span id="P4hvymX081j-HllvX50cXC0" style="font-size:12px;">&nbsp;</span></td>
                    <td><span id="ShC4nyq3dYj-HllvX50cXC0" style="font-size:12px;">&nbsp;</span></td>
                    <td><span id="EzeTnxCVAp3" style="font-size:12px;"></span></td>
                </tr>
                <tr>
                    <td><span style="font-size:12px;">Number of malaria rapid diagnostic tests (RDTs) purchased with USG funds</span></td>
                    <td><span id="q9MU74zVFbS-HllvX50cXC0" style="font-size:12px;">&nbsp;</span></td>
                    <td><span id="swR5MjbGClU-HllvX50cXC0" style="font-size:12px;">&nbsp;</span></td>
                    <td><span id="av1k6Ws36cT" style="font-size:12px;"></span></td>
                </tr>
                <tr>
                    <td><span style="font-size:12px;">Number of rapid diagnostic tests (RDTs) purchased in any fiscal year with USG funds that were distributed in this reported fiscal year</span></td>
                    <td><span id="nO2Qt1aQgGt-HllvX50cXC0" style="font-size:12px;">&nbsp;</span></td>
                    <td><span id="AhpAuZWJcm6-HllvX50cXC0" style="font-size:12px;">&nbsp;</span></td>
                    <td><span id="Sgaba8MkVHa" style="font-size:12px;"></span></td>
                </tr>
                <tr>
                    <td><span style="font-size:12px;">Number of insecticide treated (ITNs) purchased with USG funds</span></td>
                    <td><span id="pUih6k0Rw2Z-HllvX50cXC0" style="font-size:12px;">&nbsp;</span></td>
                    <td><span id="mJUczLXzUbg-HllvX50cXC0" style="font-size:12px;">&nbsp;</span></td>
                    <td><span id="TB20t4ai1nH" style="font-size:12px;"></span></td>
                </tr>
                <tr>
                    <td colspan="4"><span style="font-size:12px; font-weight: bolder;">Number of insecticide treated nets (ITNs) purchased in any fiscal year with USG funds that were distributed in this reported fiscal year</span></td>
                </tr>
                <tr>
                    <td><span style="font-size:12px;">Through campaigns</span></td>
                    <td><span id="d3GBSOMOMCJ-s3wXi7AxrqM" style="font-size:12px;">&nbsp;</span></td>
                    <td><span id="BFG2SwWoDGk-s3wXi7AxrqM" style="font-size:12px;">&nbsp;</span></td>
                    <td><span id="DI873BXKeZv" style="font-size:12px;"></span></td>
                </tr>
                <tr>
                    <td><span style="font-size:12px;">Through health facilities</span></td>
                    <td><span id="d3GBSOMOMCJ-nozAOHqLOkI" style="font-size:12px;">&nbsp;</span></td>
                    <td><span id="BFG2SwWoDGk-nozAOHqLOkI" style="font-size:12px;">&nbsp;</span></td>
                    <td><span id="o3zpWesIKOD" style="font-size:12px;"></span></td>
                </tr>
                <tr>
                    <td><span style="font-size:12px;">Through the private/commercial sector</span></td>
                    <td><span id="d3GBSOMOMCJ-ZM7SBqwEmUZ" style="font-size:12px;">&nbsp;</span></td>
                    <td><span id="BFG2SwWoDGk-ZM7SBqwEmUZ" style="font-size:12px;">&nbsp;</span></td>
                    <td><span id="Qw8gK8mtefi" style="font-size:12px;"></span></td>
                </tr>
                <tr>
                    <td><span style="font-size:12px;">Number of houses sprayed with IRS with USG funds</span></td>
                    <td><span id="otbw2kIEUGO-HllvX50cXC0" style="font-size:12px;">&nbsp;</span></td>
                    <td><span id="tYKSgbaczpT-HllvX50cXC0" style="font-size:12px;">&nbsp;</span></td>
                    <td><span id="MazTDPituok" style="font-size:12px;"></span></td>

                </tr>
                <tr>
                    <td colspan="4"><span style="font-size:12px; font-weight: bolder;">Number of houses sprayed with IRS with USG funds</span></td>
                </tr>
                <tr>
                    <td><span style="font-size:12px;">Male</span></td>
                    <td><span id="ph1qBBRzCaS-Evq43lpHFBO" style="font-size:12px;">&nbsp;</span></td>
                    <td><span id="O06aIjjaGLd-Evq43lpHFBO" style="font-size:12px;">&nbsp;</span></td>
                    <td><span id="vyNFRVd9LHj" style="font-size:12px;"></span></td>
                </tr>
                <tr>
                    <td><span style="font-size:12px;">Female</span></td>
                    <td><span id="ph1qBBRzCaS-zHSeMiszM8b" style="font-size:12px;">&nbsp;</span></td>
                    <td><span id="O06aIjjaGLd-zHSeMiszM8b" style="font-size:12px;">&nbsp;</span></td>
                    <td><span id="PXRZfgovVxj" style="font-size:12px;"></span></td>
                </tr>

                </tbody>
            </table>
        </div>
        <a href="#" class="export">Export Data into Excel</a>
    </div>
</div>
